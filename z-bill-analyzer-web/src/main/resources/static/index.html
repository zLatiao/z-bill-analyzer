<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>z-bill-analyzer</title>
    <style>
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --error-color: #F56C6C;
        }

        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --error-color: #F56C6C;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }

        .upload-container {
            position: relative;
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 600px;
            transition: all 0.3s;
        }

        .import-record {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1;
        }

        .icon-container {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f0f0;
            transition: background 0.2s;
        }

        .icon-container:hover {
            background: #e0e0e0;
        }

        .icon-clock {
            font-size: 18px;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
        }

        .import-records-popup {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        .records-list {
            padding: 8px;
        }

        .record-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .record-item:hover {
            background-color: #f8f8f8;
        }

        .drop-zone {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin: 1rem 0;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary-color);
            background: #f8f9ff;
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #f8f8f8;
            border-radius: 4px;
        }

        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .primary-btn {
            background: var(--primary-color);
            color: white;
        }

        .primary-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
<div class="upload-container">
    <!-- ÂØºÂÖ•ËÆ∞ÂΩïÂõæÊ†á -->
    <div class="import-record">
        <div class="icon-container" onclick="toggleImportRecords(event)">
            <span class="icon-clock">üïí</span>
            <span class="badge" id="importRecordCount">0</span>
        </div>
        <div class="import-records-popup" id="importRecordsPopup">
            <div class="records-list" id="recordsList"></div>
        </div>
    </div>

    <h2>ÊâπÈáèÊñá‰ª∂‰∏ä‰º†ÂàÜÊûê</h2>
    <p>ÊîØÊåÅCSVÊ†ºÂºè</p>

    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div>ÁÇπÂáªÈÄâÊã©Êñá‰ª∂ Êàñ ÊãñÊîæÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü</div>
    </div>

    <input type="file" id="fileInput" multiple accept=".csv">

    <div class="file-list" id="fileList"></div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>

    <div class="action-buttons">
        <button class="primary-btn" onclick="uploadFiles()">ÂºÄÂßãÂàÜÊûê</button>
    </div>
</div>

<script>
    // Âú®È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂØºÂÖ•Êñá‰ª∂ÁöÑËÆ∞ÂΩï
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/bill/getImportRecords')
            .then(response => {
                if (!response.ok) throw new Error('Ëé∑ÂèñÂØºÂÖ•ËÆ∞ÂΩïÂ§±Ë¥•');
                return response.json();
            })
            .then(data => {
                window.importRecords = data.data;
                document.getElementById('importRecordCount').textContent = data.data.length;
            })
            .catch(error => {
                console.error('ËØ∑Ê±ÇÂ§±Ë¥•:', error);
            });
    });

    // ÂàáÊç¢ÂØºÂÖ•ËÆ∞ÂΩïÂºπÁ™ó
    function toggleImportRecords(event) {
        event.stopPropagation();
        const popup = document.getElementById('importRecordsPopup');
        popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        if (popup.style.display === 'block') renderImportRecords();
    }

    // Ê∏≤ÊüìÂØºÂÖ•ËÆ∞ÂΩïÂàóË°®
    function renderImportRecords() {
        const recordsList = document.getElementById('recordsList');
        recordsList.innerHTML = '';

        if (!window.importRecords || window.importRecords.length === 0) {
            recordsList.innerHTML = '<div class="record-item">ÊöÇÊó†ÂØºÂÖ•ËÆ∞ÂΩï</div>';
            return;
        }

        window.importRecords.forEach(record => {
            const item = document.createElement('div');
            item.className = 'record-item';
            const importTime = new Date(record.importTime).toLocaleString();
            const fileNames = Array.isArray(record.fileNames) ?
                record.fileNames.slice(0, 2).join(', ') +
                (record.fileNames.length > 2 ? ` Á≠â${record.fileNames.length}‰∏™Êñá‰ª∂` : '') :
                record.fileNames;

            item.innerHTML = `
                <div style="font-weight:500;margin-bottom:4px;">${importTime}</div>
                <div style="font-size:0.9em;color:#666;">${fileNames}</div>
            `;

            item.addEventListener('click', () => {
                document.cookie = `IMPORT_RECORD_ID=${record.id}; path=/; max-age=86400`;
                window.location.href = '/visualization';
            });

            recordsList.appendChild(item);
        });
    }

    // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠ÂºπÁ™ó
    document.addEventListener('click', function (event) {
        const popup = document.getElementById('importRecordsPopup');
        const iconContainer = document.querySelector('.icon-container');
        if (!popup.contains(event.target) && !iconContainer.contains(event.target)) {
            popup.style.display = 'none';
        }
    });

    // Êñá‰ª∂ÂàóË°®ÁÆ°ÁêÜ
    let files = [];
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const progressBar = document.getElementById('progress');

    // ÊãñÊîæ‰∫ã‰ª∂Â§ÑÁêÜ
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
    document.getElementById('fileInput').addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(newFiles) {
        files = Array.from(newFiles);
        renderFileList();
    }

    // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®
    function renderFileList() {
        fileList.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <span style="flex:1">${file.name}</span>
                    <span>${formatSize(file.size)}</span>
                    <button onclick="removeFile(${index})" style="margin-left:1rem">√ó</button>
                </div>
            `).join('');
    }

    // Êñá‰ª∂‰∏ä‰º†ÈÄªËæë
    async function uploadFiles() {
        if (files.length === 0) {
            alert('ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰∏™Êñá‰ª∂');
            return;
        }

        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        try {
            const response = await fetch('/api/bill/parse', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('‰∏ä‰º†Â§±Ë¥•');
            let resJson = await response.json();
            if (resJson.code === 200 && resJson.data.id != null) {
                const id = resJson.data.id
                console.log("id:::::" + id)
                document.cookie = `IMPORT_RECORD_ID=${id}; path=/; max-age=86400`;
                window.location.href = '/visualization';
            }

        } catch (error) {
            alert(error.message);
            progressBar.style.width = '0%';
        }
    }

    // ËæÖÂä©ÂáΩÊï∞
    function formatSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        for (const unit of units) {
            if (size < 1024) return `${size.toFixed(1)}${unit}`;
            size /= 1024;
        }
        return `${size.toFixed(1)}GB`;
    }

    function removeFile(index) {
        files.splice(index, 1);
        renderFileList();
    }
</script>
</body>
</html>