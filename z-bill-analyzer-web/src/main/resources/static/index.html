<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>z-bill-analyzer è´¦å•åˆ†æ</title>
    <style>
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --error-color: #F56C6C;
        }

        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --error-color: #F56C6C;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }

        .upload-container {
            position: relative;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border: 1px solid rgba(64, 158, 255, 0.15); /* ä¸ä¸»è‰²ç³»å‘¼åº” */
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 600px;
            transition: all 0.3s;
        }

        h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            position: relative;
            padding-left: 1.5rem;
        }

        h2::before { /* å¢åŠ å“ç‰Œæ ‡è¯†çº¿ */
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .import-record {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1;
        }

        .icon-container {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;  /* ç¨å¾®åŠ å¤§å®¹å™¨å°ºå¯¸ */
            height: 36px;
            border-radius: 50%;
            background: #f0f0f0;
            transition: background 0.2s;
        }

        .icon-container:hover {
            background: #e0e0e0;
        }

        .icon-clock {
            font-size: 20px;  /* ç¨å¾®åŠ å¤§å›¾æ ‡ */
            position: relative;
            z-index: 1;       /* ç¡®ä¿å›¾æ ‡åœ¨å®¹å™¨æœ€ä¸Šå±‚ */
        }

        .badge {
            position: absolute;
            top: -6px;    /* è°ƒæ•´å‚ç›´ä½ç½® */
            right: -8px;  /* è°ƒæ•´æ°´å¹³ä½ç½® */
            background: var(--error-color);
            color: white;
            border-radius: 10px;  /* æ”¹ä¸ºèƒ¶å›Šå½¢çŠ¶ */
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
            line-height: 1.2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .import-records-popup {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        .records-list {
            padding: 8px;
        }

        .record-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .record-item:hover {
            background-color: #f8f8f8;
        }

        .drop-zone {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin: 1rem 0;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary-color);
            background: #f8f9ff;
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #f8f8f8;
            border-radius: 4px;
        }

        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .primary-btn {
            background: var(--primary-color);
            color: white;
        }

        .primary-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
<div class="upload-container">
    <!-- å¯¼å…¥è®°å½•å›¾æ ‡ -->
    <div class="import-record">
        <div class="icon-container" onclick="toggleImportRecords(event)">
            <span class="icon-clock">ğŸ•’</span>
            <span class="badge" id="importRecordCount">0</span>
        </div>
        <div class="import-records-popup" id="importRecordsPopup">
            <div class="records-list" id="recordsList"></div>
        </div>
    </div>

    <h2>æ‰¹é‡æ–‡ä»¶å¯¼å…¥åˆ†æ</h2>
    <p>æ”¯æŒCSVæ ¼å¼ã€‚ç›®å‰æ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ã€æ‹›å•†é“¶è¡Œã€‚</p>

    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ æˆ– æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</div>
    </div>

    <input type="file" id="fileInput" multiple accept=".csv">

    <div class="file-list" id="fileList"></div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>

    <div class="action-buttons">
        <button class="primary-btn" onclick="uploadFiles()">å¼€å§‹åˆ†æ</button>
    </div>
</div>

<script>
    // åœ¨é¡µé¢åŠ è½½æ—¶è·å–å¯¼å…¥æ–‡ä»¶çš„è®°å½•
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/bill/getImportRecords')
            .then(response => {
                if (!response.ok) throw new Error('è·å–å¯¼å…¥è®°å½•å¤±è´¥');
                return response.json();
            })
            .then(data => {
                window.importRecords = data.data;
                document.getElementById('importRecordCount').textContent = data.data.length;
            })
            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
            });
    });

    // åˆ‡æ¢å¯¼å…¥è®°å½•å¼¹çª—
    function toggleImportRecords(event) {
        event.stopPropagation();
        const popup = document.getElementById('importRecordsPopup');
        popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        if (popup.style.display === 'block') renderImportRecords();
    }

    // æ¸²æŸ“å¯¼å…¥è®°å½•åˆ—è¡¨
    function renderImportRecords() {
        const recordsList = document.getElementById('recordsList');
        recordsList.innerHTML = '';

        if (!window.importRecords || window.importRecords.length === 0) {
            recordsList.innerHTML = '<div class="record-item">æš‚æ— å¯¼å…¥è®°å½•</div>';
            return;
        }

        window.importRecords.forEach(record => {
            const item = document.createElement('div');
            item.className = 'record-item';
            const importTime = new Date(record.importTime).toLocaleString();
            const fileNames = Array.isArray(record.fileNames) ?
                record.fileNames.slice(0, 2).join(', ') +
                (record.fileNames.length > 2 ? ` ç­‰${record.fileNames.length}ä¸ªæ–‡ä»¶` : '') :
                record.fileNames;

            item.innerHTML = `
                <div style="font-weight:500;margin-bottom:4px;">${importTime}</div>
                <div style="font-size:0.9em;color:#666;">${fileNames}</div>
            `;

            item.addEventListener('click', () => {
                document.cookie = `IMPORT_RECORD_ID=${record.id}; path=/; max-age=86400`;
                window.location.href = '/visualization';
            });

            recordsList.appendChild(item);
        });
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­å¼¹çª—
    document.addEventListener('click', function (event) {
        const popup = document.getElementById('importRecordsPopup');
        const iconContainer = document.querySelector('.icon-container');
        if (!popup.contains(event.target) && !iconContainer.contains(event.target)) {
            popup.style.display = 'none';
        }
    });

    // æ–‡ä»¶åˆ—è¡¨ç®¡ç†
    let files = [];
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const progressBar = document.getElementById('progress');

    // æ‹–æ”¾äº‹ä»¶å¤„ç†
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    document.getElementById('fileInput').addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(newFiles) {
        files = Array.from(newFiles);
        renderFileList();
    }

    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
    function renderFileList() {
        fileList.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <span style="flex:1">${file.name}</span>
                    <span>${formatSize(file.size)}</span>
                    <button onclick="removeFile(${index})" style="margin-left:1rem">Ã—</button>
                </div>
            `).join('');
    }

    // æ–‡ä»¶ä¸Šä¼ é€»è¾‘
    async function uploadFiles() {
        if (files.length === 0) {
            alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ–‡ä»¶');
            return;
        }

        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        try {
            const response = await fetch('/api/bill/parse', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');
            let resJson = await response.json();
            if (resJson.code === 200 && resJson.data.id != null) {
                const id = resJson.data.id
                console.log("id:::::" + id)
                document.cookie = `IMPORT_RECORD_ID=${id}; path=/; max-age=86400`;
                window.location.href = '/visualization';
            }

        } catch (error) {
            alert(error.message);
            progressBar.style.width = '0%';
        }
    }

    // è¾…åŠ©å‡½æ•°
    function formatSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        for (const unit of units) {
            if (size < 1024) return `${size.toFixed(1)}${unit}`;
            size /= 1024;
        }
        return `${size.toFixed(1)}GB`;
    }

    function removeFile(index) {
        files.splice(index, 1);
        renderFileList();
    }
</script>
</body>
</html>